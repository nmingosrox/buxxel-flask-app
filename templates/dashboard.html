{% extends "layout.html" %}

{% block content %}
<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>My Dashboard</h2>
        <a href="{{ url_for('new_listing_page') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Add New Listing
        </a>
    </div>
    <p>Here you can manage all the listings you have posted on Buxxel.</p>
    <hr>

    <!-- Message for guests -->
    <div id="guest-message" class="alert alert-warning" style="display: none;">
        <h4>Access Denied</h4>
        <p>You must be logged in to view your dashboard. Please <a href="#" data-bs-toggle="modal" data-bs-target="#authModal">log in</a>.</p>
    </div>

    <!-- Profile Settings Section -->
    <div id="profile-settings" style="display: none;">
        <h4>Profile Settings</h4>
        <form id="profileSettingsForm" class="row g-3 align-items-center mb-4">
            <div class="col-md-5">
                <label for="usernameInput" class="form-label">Public Username</label>
                <input type="text" class="form-control" id="usernameInput" placeholder="Enter a public username">
                <div class="form-text">This will be displayed on your public profile page.</div>
            </div>
            <div class="col-md-3 align-self-end">
                <button type="submit" class="btn btn-secondary">Save Username</button>
            </div>
            <div id="profile-alert" class="col-12 mt-2" style="display: none;"></div>
        </form>
        <hr>
    </div>

    <!-- Container for listings -->
    <div id="dashboard-content" style="display: none;">
        <!-- Search and Sort Controls -->
        <div class="row justify-content-between mb-4">
            <div class="col-md-4">
                <select class="form-select" id="dashboard-sort-select">
                    <option value="created_at,desc" selected>Sort by: Newest</option>
                    <option value="price,asc">Sort by: Price (Low to High)</option>
                    <option value="price,desc">Sort by: Price (High to Low)</option>
                    <option value="stock,asc">Sort by: Stock (Low to High)</option>
                </select>
            </div>
            <div class="col-md-5">
                <input type="text" class="form-control" id="dashboard-search-bar" placeholder="Search your listings by name...">
            </div>
        </div>
        <div id="my-listings-container">
            <!-- Listings will be injected here -->
        </div>
        <div id="loading-spinner" class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div id="no-listings-message" class="text-center p-5" style="display: none;">
            <h4 class="text-muted">You haven't posted any listings yet.</h4>
            <p class="text-muted">Click the "Add New Listing" button to get started.</p>
        </div>
 
        <!-- Pagination Controls -->
        <nav id="dashboard-pagination" aria-label="Dashboard navigation" class="d-flex justify-content-center mt-4" style="display: none !important;">
            <ul class="pagination">
                <li class="page-item" id="prev-page">
                    <a class="page-link" href="#" aria-label="Previous">Previous</a>
                </li>
                <li class="page-item" id="next-page">
                    <a class="page-link" href="#" aria-label="Next">Next</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- Edit Listing Modal -->
<div class="modal fade" id="editListingModal" tabindex="-1" aria-labelledby="editListingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editListingModalLabel">Edit Listing</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editListingForm" enctype="multipart/form-data">
                    <div id="edit-listing-alert" class="alert" role="alert" style="display: none;"></div>
                    <input type="hidden" id="editListingId">
                    
                    <div class="mb-3">
                        <label for="editListingName" class="form-label">Listing Name</label>
                        <input type="text" class="form-control" id="editListingName" name="name" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editListingPrice" class="form-label">Price ($)</label>
                            <input type="number" class="form-control" id="editListingPrice" name="price" step="0.01" min="0" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editListingStock" class="form-label">Available Stock</label>
                            <input type="number" class="form-control" id="editListingStock" name="stock" min="0" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editListingTags" class="form-label">Tags</label>
                        <input type="text" class="form-control" id="editListingTags" name="tags" required>
                        <div class="form-text">Enter comma-separated tags.</div>
                    </div>
                    <div class="mb-3">
                        <label for="editListingDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editListingDescription" name="description" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Product Image</label>
                        <p class="form-text">The widget shows your current image. Upload a new one to replace it.</p>
                        <input type="hidden"
                               role="uploadcare-uploader"
                               data-images-only="true"
                               data-crop="free"
                               data-image-shrink="1920x1920 80%"
                               id="edit-uploadcare-widget" />
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Update Listing</button>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block page_scripts %}
<script>
$(document).ready(function() {    
    // --- UTILITY FUNCTIONS ---

    // Debounce function to limit the rate at which a function gets called.
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    let currentPage = 1;

    async function getSession() {
        const { data, error } = await supabaseClient.auth.getSession();
        if (error || !data.session) {
            // This is a guest user
            return null;
        }
        return data.session;
    }

    async function loadDashboard(page = 1, searchTerm = '', sortBy = 'created_at', sortOrder = 'desc') {
        const session = await getSession();

        if (!session) {
            $('#guest-message').show();
            $('#profile-settings').hide();
            $('#loading-spinner').hide();
            return;
        }

        $('#dashboard-content').show();
        $('#loading-spinner').show();
        $('#my-listings-container').empty(); // Clear previous listings
        $('#dashboard-pagination').hide();

        // Fetch and display user's listings
        $.ajax({
            url: `/api/me/listings?page=${page}&search=${encodeURIComponent(searchTerm)}&sort_by=${sortBy}&sort_order=${sortOrder}`,
            type: 'GET',
            beforeSend: function(xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + session.access_token);
            },
            success: function(response) {
                $('#loading-spinner').hide();
                const container = $('#my-listings-container');
                const listings = response.listings;
                const pagination = response.pagination;

                currentPage = pagination.page;

                if (listings.length === 0 && searchTerm.length === 0) {
                    // Only show the "no listings" message if there's no search term
                    $('#no-listings-message').show();
                    return;
                } else if (listings.length === 0 && searchTerm.length > 0) {
                    $('#no-listings-message').show();
                    return;
                }

                $('#no-listings-message').hide();

                listings.forEach(listing => {
                    // Use the first image from the 'image_urls' array
                    const imageUrl = (listing.image_urls && listing.image_urls.length > 0) ? listing.image_urls[0] : 'https://via.placeholder.com/300x200.png?text=No+Image';
                    
                    // Safely create DOM elements to prevent XSS
                    const card = $('<div>').addClass('card mb-3').attr('id', `listing-card-${listing.id}`);
                    const row = $('<div>').addClass('row g-0');

                    const imgCol = $('<div>').addClass('col-md-2');
                    const imgLink = $('<a>').addClass('image-preview-trigger').attr('href', '#')
                        .attr('data-bs-toggle', 'modal')
                        .attr('data-bs-target', '#imagePreviewModal')
                        .attr('data-image-url', imageUrl);
                    const img = $('<img>').attr('src', imageUrl).addClass('img-fluid rounded-start').attr('alt', listing.name).css({width: '100%', height: '150px', 'object-fit': 'cover'});
                    imgLink.append(img);
                    imgCol.append(imgLink);

                    const bodyCol = $('<div>').addClass('col-md-10');
                    const cardBody = $('<div>').addClass('card-body');
                    const flexContainer = $('<div>').addClass('d-flex justify-content-between');

                    const infoDiv = $('<div>');
                    infoDiv.append($('<h5>').addClass('card-title').text(listing.name));
                    const smallText = `Tags: ${(listing.tags || []).join(', ')} | Price: $${listing.price.toFixed(2)} | Stock: ${listing.stock}`;
                    infoDiv.append($('<p>').addClass('card-text').append($('<small>').addClass('text-muted').text(smallText)));

                    const actionsDiv = $('<div>');
                    // Edit button
                    actionsDiv.append($('<button>')
                        .addClass('btn btn-outline-secondary btn-sm me-2 edit-listing-btn')
                        .attr('data-bs-toggle', 'modal').attr('data-bs-target', '#editListingModal')
                        .attr('data-listing-id', listing.id)
                        .text('Edit'));

                    // Status dropdown
                    const statusDropdown = `
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm ${listing.stock > 0 ? 'btn-outline-success' : 'btn-outline-warning'} dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                ${listing.stock > 0 ? 'In Stock' : 'Out of Stock'}
                            </button>
                            <ul class="dropdown-menu">
                                ${listing.stock > 0 
                                    ? `<li><a class="dropdown-item status-toggle-btn" href="#" data-id="${listing.id}" data-status="out_of_stock">Mark as Out of Stock</a></li>`
                                    : `<li><a class="dropdown-item status-toggle-btn" href="#" data-id="${listing.id}" data-status="in_stock">Mark as In Stock</a></li>`
                                }
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger delete-listing-btn" href="#" data-id="${listing.id}">Delete Permanently</a></li>
                            </ul>
                        </div>
                    `;
                    actionsDiv.append(statusDropdown);

                    flexContainer.append(infoDiv, actionsDiv);
                    cardBody.append(flexContainer);
                    bodyCol.append(cardBody);
                    row.append(imgCol, bodyCol);
                    card.append(row);

                    container.append(card);
                });

                // Update and show pagination controls
                if (pagination.page > 1 || pagination.has_next) {
                    $('#dashboard-pagination').show();
                    if (pagination.page > 1) {
                        $('#prev-page').removeClass('disabled');
                    } else {
                        $('#prev-page').addClass('disabled');
                    }
                    $('#next-page').toggleClass('disabled', !pagination.has_next);
                } else {
                    $('#dashboard-pagination').hide();
                }
            },
            error: function(xhr) {
                $('#loading-spinner').hide();
                alert('Failed to load your listings. Please try again.');
            }
        });
    }

    // Search bar handler
    $('#dashboard-search-bar').on('keyup', debounce(function() {
        const searchTerm = $(this).val();
        const [sortBy, sortOrder] = $('#dashboard-sort-select').val().split(',');
        loadDashboard(1, searchTerm, sortBy, sortOrder); // Always reset to page 1
    }, 400)); // 400ms delay

    // Sort dropdown handler
    $('#dashboard-sort-select').on('change', function() {
        const searchTerm = $('#dashboard-search-bar').val();
        const [sortBy, sortOrder] = $(this).val().split(',');
        loadDashboard(1, searchTerm, sortBy, sortOrder); // Always reset to page 1
    });

    // Pagination click handlers
    $('#prev-page a').on('click', function(e) {
        e.preventDefault();
        const searchTerm = $('#dashboard-search-bar').val();
        const [sortBy, sortOrder] = $('#dashboard-sort-select').val().split(',');
        if (currentPage > 1) loadDashboard(currentPage - 1, searchTerm, sortBy, sortOrder);
    });
    $('#next-page a').on('click', function(e) {
        e.preventDefault();
        const searchTerm = $('#dashboard-search-bar').val();
        const [sortBy, sortOrder] = $('#dashboard-sort-select').val().split(',');
        loadDashboard(currentPage + 1, searchTerm, sortBy, sortOrder);
    });

    // --- PROFILE SETTINGS LOGIC ---

    async function loadProfileSettings() {
        const session = await getSession();
        if (!session) return;

        $('#profile-settings').show();

        $.ajax({
            url: '/api/me/profile',
            type: 'GET',
            beforeSend: function(xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + session.access_token);
            },
            success: function(profile) {
                if (profile && profile.username) {
                    $('#usernameInput').val(profile.username);
                }
            }
        });
    }

    $('#profileSettingsForm').on('submit', async function(e) {
        e.preventDefault();
        const session = await getSession();
        if (!session) return;

        const username = $('#usernameInput').val();
        const alertDiv = $('#profile-alert');

        $.ajax({
            url: '/api/me/profile',
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({ username: username }),
            beforeSend: function(xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + session.access_token);
            },
            success: function(response) {
                alertDiv.html('<div class="alert alert-success">Username updated successfully!</div>').show().delay(3000).fadeOut();
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'An error occurred.';
                alertDiv.html(`<div class="alert alert-danger">${errorMsg}</div>`).show();
            }
        });
    });


    // Handle delete button click
    $('#my-listings-container').on('click', '.delete-listing-btn', async function(e) {
        e.preventDefault();
        const listingId = $(this).data('id');
        const deleteBtn = $(this);
        
        if (!confirm('Are you sure you want to delete this listing? This action cannot be undone.')) {
            return;
        }

        const session = await getSession();
        if (!session) return;

        $.ajax({
            url: `/api/listings/${listingId}`,
            type: 'DELETE',
            beforeSend: function(xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + session.access_token);
                // Provide immediate feedback by disabling the button
                deleteBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');
            },
            success: function(response) {
                // On success, fade out the card and remove it.
                $(`#listing-card-${listingId}`).fadeOut(500, function() { 
                    $(this).remove(); 
                    // After removing, check if the container is empty.
                    if ($('#my-listings-container').children().length === 0 && currentPage > 0) {
                        // If we deleted the last item, reload the dashboard.
                        // This will either show the previous page or the "no listings" message.
                        const searchTerm = $('#dashboard-search-bar').val();
                        const [sortBy, sortOrder] = $('#dashboard-sort-select').val().split(',');
                        loadDashboard(currentPage, searchTerm, sortBy, sortOrder);
                    }
                });
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to delete listing.';
                alert(errorMsg);
                // Re-enable the button on error
                deleteBtn.prop('disabled', false).text('Delete');
            }
        });
    });

    // Handle status toggle button click
    $('#my-listings-container').on('click', '.status-toggle-btn', async function(e) {
        e.preventDefault();
        const listingId = $(this).data('id');
        const newStatus = $(this).data('status');
        const statusBtn = $(this).closest('.btn-group').find('button').first();

        const session = await getSession();
        if (!session) return;

        $.ajax({
            url: `/api/listings/${listingId}/status`,
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({ status: newStatus }),
            beforeSend: function(xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + session.access_token);
                statusBtn.prop('disabled', true);
            },
            success: function(updatedListing) {
                // --- Update the card UI in real-time ---
                const card = $(`#listing-card-${listingId}`);
                
                // 1. Reload the entire card to update all elements (dropdown, text, etc.)
                const searchTerm = $('#dashboard-search-bar').val();
                const [sortBy, sortOrder] = $('#dashboard-sort-select').val().split(',');
                // A small delay can make the UI feel smoother
                setTimeout(() => {
                    loadDashboard(currentPage, searchTerm, sortBy, sortOrder);
                }, 300);
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to update status.';
                alert(errorMsg);
                statusBtn.prop('disabled', false);
            }
        });
    });

    // --- EDIT MODAL LOGIC ---

    // 1. When the edit modal is about to be shown...
    $('#editListingModal').on('show.bs.modal', async function (event) {
        const button = $(event.relatedTarget); // Button that triggered the modal
        const listingId = button.data('listing-id');
        const modal = $(this);

        modal.find('#editListingId').val(listingId);

        const session = await getSession();
        if (!session) return;

        // Fetch the specific listing data to pre-fill the form
        $.ajax({
            url: `/api/listings/${listingId}`,
            type: 'GET',
            beforeSend: function(xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + session.access_token);
            },
            success: function(listing) {
                modal.find('#editListingName').val(listing.name);
                modal.find('#editListingPrice').val(listing.price);
                modal.find('#editListingStock').val(listing.stock);
                modal.find('#editListingDescription').val(listing.description);
                modal.find('#editListingTags').val((listing.tags || []).join(', '));

                // Pre-fill the Uploadcare widget with the existing image URL
                const imageUrl = (listing.image_urls && listing.image_urls.length > 0) ? listing.image_urls[0] : '';
                const widget = uploadcare.Widget(modal.find('#edit-uploadcare-widget'));
                if (imageUrl) {
                    widget.value(imageUrl);
                } else {
                    widget.value(null);
                }
            },
            error: function(xhr) {
                alert('Could not load listing data. Please try again.');
                modal.modal('hide');
            }
        });
    });

    // 2. Handle the edit form submission
    $('#editListingForm').on('submit', async function(event) {
        event.preventDefault();

        const form = $(this);
        const listingId = $('#editListingId').val();
        const submitBtn = form.find('button[type="submit"]');
        const originalBtnHtml = submitBtn.html();
        const alertDiv = $('#edit-listing-alert');

        const session = await getSession();
        if (!session) return;

        const imageUrl = $('#edit-uploadcare-widget').val();
        if (!imageUrl) {
            alertDiv.text('Please ensure an image is uploaded.').removeClass('alert-success').addClass('alert-danger').show();
            return;
        }

        const updatedData = {
            name: $('#editListingName').val(),
            price: $('#editListingPrice').val(),
            stock: $('#editListingStock').val(),
            description: $('#editListingDescription').val(),
            image_url: imageUrl,
            tags: $('#editListingTags').val()
        };

        $.ajax({
            url: `/api/listings/${listingId}`,
            type: 'PUT',
            data: updatedData,
            beforeSend: function(xhr) {
                submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Updating...');
                xhr.setRequestHeader('Authorization', 'Bearer ' + session.access_token);
            },
            success: function(updatedListing) {
                alertDiv.text('Listing updated successfully!').removeClass('alert-danger').addClass('alert-success').show();
                
                // Update the card on the page without reloading
                const card = $(`#listing-card-${listingId}`);
                card.find('.card-title').text(updatedListing.name);
                const smallText = `Tags: ${(updatedListing.tags || []).join(', ')} | Price: $${updatedListing.price.toFixed(2)} | Stock: ${updatedListing.stock}`;
                card.find('.text-muted').text(smallText);
                const newImageUrl = (updatedListing.image_urls && updatedListing.image_urls.length > 0) ? updatedListing.image_urls[0] : '';
                card.find('.img-fluid').attr('src', newImageUrl);

                setTimeout(() => {
                    $('#editListingModal').modal('hide');
                    alertDiv.hide().text('');
                    submitBtn.prop('disabled', false).html(originalBtnHtml);
                }, 1500);
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'An error occurred.';
                alertDiv.text(errorMsg).removeClass('alert-success').addClass('alert-danger').show();
                submitBtn.prop('disabled', false).html(originalBtnHtml);
            }
        });
    });

    loadDashboard();
    loadProfileSettings();
});
</script>
{% endblock %}