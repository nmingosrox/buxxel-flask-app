{% extends "layout.html" %}

{% block content %}
<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>My Dashboard</h2>
        <a href="{{ url_for('new_listing_page') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Add New Listing
        </a>
    </div>
    <p>Here you can manage all the listings you have posted on Buxxel.</p>
    <hr>

    <!-- Message for guests -->
    <div id="guest-message" class="alert alert-warning" style="display: none;">
        <h4>Access Denied</h4>
        <p>You must be logged in to view your dashboard. Please <a href="#" data-bs-toggle="modal" data-bs-target="#authModal">log in</a>.</p>
    </div>

    <!-- Container for listings -->
    <div id="dashboard-content" style="display: none;">
        <div id="my-listings-container">
            <!-- Listings will be injected here -->
        </div>
        <div id="loading-spinner" class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div id="no-listings-message" class="text-center p-5" style="display: none;">
            <h4 class="text-muted">You haven't posted any listings yet.</h4>
            <p class="text-muted">Click the "Add New Listing" button to get started.</p>
        </div>
    </div>
{% endblock %}

{% block page_scripts %}
<script>
$(document).ready(function() {
    const session = JSON.parse(localStorage.getItem('supabaseSession'));

    if (!session || !session.user) {
        $('#guest-message').show();
        $('#loading-spinner').hide();
        return;
    }

    $('#dashboard-content').show();

    // Fetch and display user's listings
    $.ajax({
        url: '/api/me/listings',
        type: 'GET',
        beforeSend: function(xhr) {
            xhr.setRequestHeader('Authorization', 'Bearer ' + session.access_token);
        },
        success: function(listings) {
            $('#loading-spinner').hide();
            const container = $('#my-listings-container');
            if (listings.length === 0) {
                $('#no-listings-message').show();
                return;
            }

            listings.forEach(listing => {
                const listingCard = `
                    <div class="card mb-3" id="listing-card-${listing.id}">
                        <div class="row g-0">
                            <div class="col-md-2">
                                <img src="${listing.image}" class="img-fluid rounded-start" alt="${listing.name}" style="width: 100%; height: 150px; object-fit: cover;">
                            </div>
                            <div class="col-md-10">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h5 class="card-title">${listing.name}</h5>
                                            <p class="card-text"><small class="text-muted">Category: ${listing.category} | Price: $${listing.price.toFixed(2)} | Stock: ${listing.stock}</small></p>
                                        </div>
                                        <div>
                                            <a href="/edit-listing/${listing.id}" class="btn btn-outline-secondary btn-sm">Edit</a>
                                            <button class="btn btn-outline-danger btn-sm delete-listing-btn" data-id="${listing.id}">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.append(listingCard);
            });
        },
        error: function(xhr) {
            $('#loading-spinner').hide();
            alert('Failed to load your listings. Please try again.');
        }
    });

    // Handle delete button click
    $('#my-listings-container').on('click', '.delete-listing-btn', function() {
        const listingId = $(this).data('id');
        
        if (!confirm('Are you sure you want to delete this listing? This action cannot be undone.')) {
            return;
        }

        $.ajax({
            url: `/api/listings/${listingId}`,
            type: 'DELETE',
            beforeSend: function(xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + session.access_token);
            },
            success: function(response) {
                // Remove the card from the DOM
                $(`#listing-card-${listingId}`).fadeOut(500, function() { $(this).remove(); });
                alert('Listing deleted successfully.');
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to delete listing.';
                alert(errorMsg);
            }
        });
    });
});
</script>
{% endblock %}