{% extends "layout.html" %}

{% block content %}
<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>My Dashboard</h2>
        <a href="{{ url_for('new_listing_page') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Add New Listing
        </a>
    </div>
    <p>Here you can manage all the listings you have posted on Buxxel.</p>
    <hr>

    <!-- Message for guests -->
    <div id="guest-message" class="alert alert-warning" style="display: none;">
        <h4>Access Denied</h4>
        <p>You must be logged in to view your dashboard. Please <a href="#" data-bs-toggle="modal" data-bs-target="#authModal">log in</a>.</p>
    </div>

    <!-- Container for listings -->
    <div id="dashboard-content" style="display: none;">
        <div id="my-listings-container">
            <!-- Listings will be injected here -->
        </div>
        <div id="loading-spinner" class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div id="no-listings-message" class="text-center p-5" style="display: none;">
            <h4 class="text-muted">You haven't posted any listings yet.</h4>
            <p class="text-muted">Click the "Add New Listing" button to get started.</p>
        </div>
    </div>
</div>

<!-- Edit Listing Modal -->
<div class="modal fade" id="editListingModal" tabindex="-1" aria-labelledby="editListingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editListingModalLabel">Edit Listing</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editListingForm" enctype="multipart/form-data">
                    <div id="edit-listing-alert" class="alert" role="alert" style="display: none;"></div>
                    <input type="hidden" id="editListingId">
                    
                    <div class="mb-3">
                        <label for="editListingName" class="form-label">Listing Name</label>
                        <input type="text" class="form-control" id="editListingName" name="name" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editListingPrice" class="form-label">Price ($)</label>
                            <input type="number" class="form-control" id="editListingPrice" name="price" step="0.01" min="0" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editListingStock" class="form-label">Available Stock</label>
                            <input type="number" class="form-control" id="editListingStock" name="stock" min="0" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editListingCategory" class="form-label">Category</label>
                        <select class="form-select" id="editListingCategory" name="category" required>
                            <option selected disabled value="">Choose...</option>
                            <option>Food</option>
                            <option>Personal Care</option>
                            <option>Produce</option>
                            <option>Bakery</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editListingDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editListingDescription" name="description" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Product Image</label>
                        <p class="form-text">The widget shows your current image. Upload a new one to replace it.</p>
                        <input type="hidden" role="uploadcare-uploader" data-images-only="true" data-crop="free" id="edit-uploadcare-widget" />
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Update Listing</button>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block page_scripts %}
<script>
$(document).ready(function() {    
    async function getSession() {
        const { data, error } = await supabaseClient.auth.getSession();
        if (error || !data.session) {
            // This is a guest user
            return null;
        }
        return data.session;
    }

    async function loadDashboard() {
        const session = await getSession();

        if (!session) {
            $('#guest-message').show();
            $('#loading-spinner').hide();
            return;
        }

        $('#dashboard-content').show();

        // Fetch and display user's listings
        $.ajax({
            url: '/api/me/listings',
            type: 'GET',
            beforeSend: function(xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + session.access_token);
            },
            success: function(listings) {
                $('#loading-spinner').hide();
                const container = $('#my-listings-container');
                if (listings.length === 0) {
                    $('#no-listings-message').show();
                    return;
                }

                listings.forEach(listing => {
                    // Use the first image from the 'image_urls' array
                    const imageUrl = (listing.image_urls && listing.image_urls.length > 0) ? listing.image_urls[0] : 'https://via.placeholder.com/300x200.png?text=No+Image';
                    
                    // Safely create DOM elements to prevent XSS
                    const card = $('<div>').addClass('card mb-3').attr('id', `listing-card-${listing.id}`);
                    const row = $('<div>').addClass('row g-0');

                    const imgCol = $('<div>').addClass('col-md-2');
                    const img = $('<img>').attr('src', imageUrl).addClass('img-fluid rounded-start').attr('alt', listing.name).css({width: '100%', height: '150px', 'object-fit': 'cover'});
                    imgCol.append(img);

                    const bodyCol = $('<div>').addClass('col-md-10');
                    const cardBody = $('<div>').addClass('card-body');
                    const flexContainer = $('<div>').addClass('d-flex justify-content-between');

                    const infoDiv = $('<div>');
                    infoDiv.append($('<h5>').addClass('card-title').text(listing.name));
                    const smallText = `Category: ${listing.category} | Price: $${listing.price.toFixed(2)} | Stock: ${listing.stock}`;
                    infoDiv.append($('<p>').addClass('card-text').append($('<small>').addClass('text-muted').text(smallText)));

                    const actionsDiv = $('<div>');
                    // Change the edit link to a button that triggers the modal
                    actionsDiv.append($('<button>')
                        .addClass('btn btn-outline-secondary btn-sm me-2 edit-listing-btn')
                        .attr('data-bs-toggle', 'modal').attr('data-bs-target', '#editListingModal')
                        .attr('data-listing-id', listing.id)
                        .text('Edit'));
                    actionsDiv.append($('<button>').addClass('btn btn-outline-danger btn-sm delete-listing-btn').attr('data-id', listing.id).text('Delete'));

                    flexContainer.append(infoDiv, actionsDiv);
                    cardBody.append(flexContainer);
                    bodyCol.append(cardBody);
                    row.append(imgCol, bodyCol);
                    card.append(row);

                    container.append(card);
                });
            },
            error: function(xhr) {
                $('#loading-spinner').hide();
                alert('Failed to load your listings. Please try again.');
            }
        });
    }

    // Handle delete button click
    $('#my-listings-container').on('click', '.delete-listing-btn', async function() {
        const listingId = $(this).data('id');
        const deleteBtn = $(this);
        
        if (!confirm('Are you sure you want to delete this listing? This action cannot be undone.')) {
            return;
        }

        const session = await getSession();
        if (!session) return;

        $.ajax({
            url: `/api/listings/${listingId}`,
            type: 'DELETE',
            beforeSend: function(xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + session.access_token);
                // Provide immediate feedback by disabling the button
                deleteBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');
            },
            success: function(response) {
                // On success, fade out the card and remove it.
                $(`#listing-card-${listingId}`).fadeOut(500, function() { 
                    $(this).remove(); 
                    // After removing, check if the container is empty.
                    if ($('#my-listings-container').children().length === 0) {
                        $('#no-listings-message').show();
                    }
                });
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to delete listing.';
                alert(errorMsg);
                // Re-enable the button on error
                deleteBtn.prop('disabled', false).text('Delete');
            }
        });
    });

    // --- EDIT MODAL LOGIC ---

    // 1. When the edit modal is about to be shown...
    $('#editListingModal').on('show.bs.modal', async function (event) {
        const button = $(event.relatedTarget); // Button that triggered the modal
        const listingId = button.data('listing-id');
        const modal = $(this);

        modal.find('#editListingId').val(listingId);

        const session = await getSession();
        if (!session) return;

        // Fetch the specific listing data to pre-fill the form
        $.ajax({
            url: `/api/listings/${listingId}`,
            type: 'GET',
            beforeSend: function(xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + session.access_token);
            },
            success: function(listing) {
                modal.find('#editListingName').val(listing.name);
                modal.find('#editListingPrice').val(listing.price);
                modal.find('#editListingStock').val(listing.stock);
                modal.find('#editListingCategory').val(listing.category);
                modal.find('#editListingDescription').val(listing.description);

                // Pre-fill the Uploadcare widget with the existing image URL
                const imageUrl = (listing.image_urls && listing.image_urls.length > 0) ? listing.image_urls[0] : '';
                const widget = uploadcare.Widget(modal.find('#edit-uploadcare-widget'));
                if (imageUrl) {
                    widget.value(imageUrl);
                } else {
                    widget.value(null);
                }
            },
            error: function(xhr) {
                alert('Could not load listing data. Please try again.');
                modal.modal('hide');
            }
        });
    });

    // 2. Handle the edit form submission
    $('#editListingForm').on('submit', async function(event) {
        event.preventDefault();

        const form = $(this);
        const listingId = $('#editListingId').val();
        const submitBtn = form.find('button[type="submit"]');
        const originalBtnHtml = submitBtn.html();
        const alertDiv = $('#edit-listing-alert');

        const session = await getSession();
        if (!session) return;

        const imageUrl = $('#edit-uploadcare-widget').val();
        if (!imageUrl) {
            alertDiv.text('Please ensure an image is uploaded.').removeClass('alert-success').addClass('alert-danger').show();
            return;
        }

        const updatedData = {
            name: $('#editListingName').val(),
            price: $('#editListingPrice').val(),
            stock: $('#editListingStock').val(),
            category: $('#editListingCategory').val(),
            description: $('#editListingDescription').val(),
            image_url: imageUrl
        };

        $.ajax({
            url: `/api/listings/${listingId}`,
            type: 'PUT',
            data: updatedData,
            beforeSend: function(xhr) {
                submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Updating...');
                xhr.setRequestHeader('Authorization', 'Bearer ' + session.access_token);
            },
            success: function(updatedListing) {
                alertDiv.text('Listing updated successfully!').removeClass('alert-danger').addClass('alert-success').show();
                
                // Update the card on the page without reloading
                const card = $(`#listing-card-${listingId}`);
                card.find('.card-title').text(updatedListing.name);
                const smallText = `Category: ${updatedListing.category} | Price: $${updatedListing.price.toFixed(2)} | Stock: ${updatedListing.stock}`;
                card.find('.text-muted').text(smallText);
                const newImageUrl = (updatedListing.image_urls && updatedListing.image_urls.length > 0) ? updatedListing.image_urls[0] : '';
                card.find('.img-fluid').attr('src', newImageUrl);

                setTimeout(() => {
                    $('#editListingModal').modal('hide');
                    alertDiv.hide().text('');
                    submitBtn.prop('disabled', false).html(originalBtnHtml);
                }, 1500);
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'An error occurred.';
                alertDiv.text(errorMsg).removeClass('alert-success').addClass('alert-danger').show();
                submitBtn.prop('disabled', false).html(originalBtnHtml);
            }
        });
    });

    loadDashboard();
});
</script>
{% endblock %}